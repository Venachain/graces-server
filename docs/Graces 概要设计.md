# Graces 概要设计

|    时间    | 修改人 | 修改事项 | 版本  |
| :--------: | :----: | :------: | :---: |
| 2021.09.15 |  杨毅  |   整理   | 0.0.2 |
| 2021.07.28 |  杨毅  |   初稿   | 0.0.1 |

[TOC]

## 一. 概述

依照《Graces 需求说明》所述的功能需求，为了便于 Graces 开发，目前将 Graces 按功能划分为如下三大模块：

- 链数据获取模块
- 链数据展示模块
- 链操作模块

## 二. 链数据获取模块

该模块主要用于从链上获取所需的链数据。

### 要获取的数据

- 节点数据
- 区块数据
- 交易数据
- 合约数据
- CNS 数据
- 账户数据

### 数据获取方式

通过数据同步来获取所需的数据，支持全量同步与增量同步两种方式：

- 全量

  忽略 Graces 已成功同步的链数据，从头开始重新去链上拉取所有所需的链数据。

- 增量

  基于 Graces 已成功同步的链数据，在此基础上去链上拉取后续的链数据。

### 模型抽取

- 链信息模型：chain

  - 链 id：id
  - 链名称：name
  - 部署链时所需的指定服务器的执行用户的用户名：username
  - 链的首节点 IP 地址：ip
  - 链的首节点 RPC 端口号：rpc_port
  - 链的首节点 P2P 端口号：p2p_port
  - 链的首节点 websocket 端口号：ws_port
  - 链的首节点配置信息：chain_config
  - 链的描述信息：desc
  - 创建时间：create_time
  - 更新时间：update_time
  - 删除时间：delete_time
- 节点信息模型：node
  - 节点 id：id
  - 所属链 id：chain_id
  - 节点名称：name
  - 节点公钥：public_key
  - 节点内网 IP：internal_ip
  - 节点公网 IP：external_ip
  - 节点 RPC 端口：rpc_port
  - 节点 P2P 端口：p2p_port
  - 节点类型：type
  - 节点状态：status
  - 节点部署人：owner
  - 节点描述：desc
- 区块信息模型：block

  - 区块 id：id
  - 所属链 id：chain_id
  - 区块哈希：hash
  - 区块的块高：height
  - 区块生成时间：timestamp
  - 区块内的交易总量：tx_amount
  - 打包该区块的人：proposer
  - Gas 总使用量：gas_used
  - Gas 总限制量：gas_limit
  - 上一区块哈希：parent_hash
  - 区块大小：size
  - 其他额外信息：extra_data
- 交易信息模型：tx

  - 交易 id：id
  - 所属链 id：chain_id
  - 所属区块 id：block_id
  - 交易哈希：hash
  - 所在区块的块高：height
  - 交易发起时间：timestamp
  - 交易发起方地址：from
  - 交易接收方地址：to
  - Gas价格：gas_price
  - Gas限制：gas_limit
  - 交易随机数：nonce
  - 交易数据：input
  - 交易额：value
  - 交易收据信息 ：receipt
- 收据信息模型：receipt
  - 合约地址：contract_hash
  - 交易状态：status
  - 触发事件：event
  - Gas 使用量：gas_used
- 合约信息模型：contract
  - 所属链 id：chain_id
  - 合约地址：address
  - 合约创建人地址：creator
  - 部署合约时发生的交易哈希：tx_hash
  - 合约内容：content
  - 合约部署时间：timestamp
- CNS 信息模型：cns

  - CNS id：id
  - 所属链 id：chain_id
  - CNS 名字：name
  - CNS 版本：version
  - 合约地址：address

## 三. 链数据展示模块

### 数据查询

- 可支持查询的数据
  - 链信息
    - 通过链名称
    - 通过链 IP
  - 交易
    - 通过哈希
  - 区块
    - 通过块高
    - 通过块哈希
  - 账户
    - 通过账户地址
  - CNS 名称
    - 通过名字
    - 通过合约地址
  - 节点
    - 通过节点名称
    - 通过节点 IP 地址
- 支持的查询功能

  - 等值查询

    按具体的值查询

  - 范围查询

    按时间范围查询

### 数据展示

- 列表展示
  - 链信息列表
  - 区块列表
  - 交易列表
    - 当前链的所有交易列表
    - 当前区块关联的所有交易列表
    - 当前账户关联的所有交易列表
  - 节点监控列表
- 详情展示
  - 链详情信息
    - 链基本信息 
    - 区块总数
    - 交易总数
    - 自定义合约总数
  - 区块详情信息
    - 区块基本信息
    - 区块关联的交易列表
  - 交易详情信息
    - 交易基本信息 
    - 如果是合约调用，则展示调用相关的代码 
    - 如果是合约部署，则展示部署的合约的内容
  - 地址详情信息
    - 地址基本信息
    - 地址关联的交易列表
  - 节点详情信息
    - 节点的基本信息
  - CNS 详情信息
    - CNS 基本信息

## 四. 链操作模块

### 新链的部署

1. 按步骤拆分一键部署脚本为多个部署脚本。
2. 按步骤在本地命令行中请求远程部署服务器执行拆分后的部署脚本进行部署。
3. 获取每个脚本的执行信息，只有上个步骤执行成功才能进行下个脚本的执行。
4. 所有步骤都执行成功才能认为是部署成功，否则可以选择从断点处继续部署或是所有步骤全部重新执行。
5. 以上所有步骤的执行信息需要返回给前端展示。

### 链系统参数配置

- 获取系统参数

  可通过接口获取指定系统参数的值。

- 设置系统参数

  可通过接口对指定系统参数进行设置。

### 链节点操作

- 节点监控

  通过接口获取节点列表数据，并在节点列表中及时更新节点的状态信息。

- 添加节点 

  通过脚本为已在运行的链或新部署的链添加新的节点。

- 启动节点

  通过脚本启动链已有的处于关闭状态的节点。

- 关闭节点

  通过脚本关闭链已有的处于运行状态的节点。

- 重启节点

  通过脚本重启链已有的处于运行状态的节点。

### CNS 配置

- CNS 注册

  通过接口将已部署成的合约地址注册进 CNS 管理器中。

- CNS 重定向

  通过接口将 CNS 重定向到指定版本号。

### 链合约操作

- 开启合约防火墙

  通过接口开启指定合约的防火墙。

- 关闭合约防火墙

  通过接口关闭指定合约的防火墙。

- 部署合约

  上传合约文件，通过脚本将合约部署到链上。

